<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XR Training Labs | Persistent Expansion</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Source+Code+Pro&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handtrackjs/dist/handtrack.min.js"></script>

    <style>
        :root {
            --bg-color: #030508;
            --text-color: #ffffff;
            --accent-color: #6366f1;
            --hud-green: #4ade80;
            --model-bg: #111418;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Ensure body is transparent to see the canvas behind it */
        body { 
            font-family: 'Inter', sans-serif; 
            background: transparent; 
            color: var(--text-color); 
            overflow-x: hidden;
            position: relative;
        }

        /* --- THE FIX: Explicitly positioned and sized --- */
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: block;
            z-index: -1; 
            background-color: var(--bg-color); /* The base dark color lives here now */
            pointer-events: none;
        }

        nav { position: fixed; top: 0; width: 100%; padding: 20px 5%; display: flex; justify-content: space-between; z-index: 1000; backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border); }
        .logo { font-weight: 700; font-family: 'Source Code Pro', monospace; color: var(--accent-color); font-size: 1rem; }

        section { padding: 140px 5% 60px; min-height: 90vh; display: flex; flex-direction: column; justify-content: center; position: relative; z-index: 10; }
        
        h1 { font-size: clamp(2.5rem, 8vw, 5rem); font-weight: 700; line-height: 1; margin-bottom: 10px; text-transform: uppercase; letter-spacing: -2px; }
        h2.sub-heading { font-size: clamp(1.2rem, 3vw, 2rem); font-weight: 300; color: var(--accent-color); margin-bottom: 25px; text-transform: uppercase; letter-spacing: 2px; }
        
        .intro-text { font-size: 1.1rem; color: #aaa; max-width: 800px; line-height: 1.6; margin-bottom: 40px; }
        .ar-content { margin-bottom: 20px; display: inline-block; padding: 5px 15px; border-left: 3px solid var(--accent-color); background: rgba(99, 102, 241, 0.05); font-family: 'Source Code Pro', monospace; font-size: 0.8rem; }

        /* --- 2 x 2 Video Grid --- */
        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 30px; 
            max-width: 1200px; 
            margin: 20px 0; 
        }

        .video-card { 
            position: relative; 
            width: 100%;
            aspect-ratio: 16/9; 
            border-radius: 12px; 
            overflow: hidden; 
            background: #000;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            z-index: 1;
        }

        .video-card iframe { width: 100%; height: 100%; border: 0; pointer-events: none; transform: scale(1.05); }

        /* --- Hand UI --- */
        #hand-ui { margin-top: 30px; display: flex; align-items: center; gap: 20px; }
        .cam-btn { background: var(--accent-color); color: white; border: none; padding: 12px 24px; border-radius: 4px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; font-family: 'Source Code Pro', monospace; }
        #preview-wrapper { position: relative; width: 140px; height: 105px; display: none; }
        #v-preview { width: 100%; height: 100%; border-radius: 4px; border: 1px solid var(--accent-color); transform: scaleX(-1); filter: grayscale(1) brightness(0.8); }

        /* --- Model Card --- */
        .model-card { 
            width: 90%; 
            height: 65vh; 
            background: var(--model-bg); 
            border-radius: 24px; 
            border: 1px solid var(--glass-border); 
            position: relative; 
            overflow: hidden; 
            margin: 30px auto 0 auto;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
        }
        
        model-viewer { width: 100%; height: 100%; --poster-color: transparent; }

        #tech-hud {
            position: absolute;
            top: 25px;
            left: 25px;
            padding: 20px;
            background: rgba(5, 7, 10, 0.9);
            border: 1px solid var(--hud-green);
            color: var(--hud-green);
            font-family: 'Source Code Pro', monospace;
            font-size: 0.7rem;
            pointer-events: none;
            opacity: 0;
            transition: 0.4s ease;
            z-index: 5;
        }
        #tech-hud.active { opacity: 1; }

        .ar-controls { display: flex; justify-content: center; margin-top: 25px; }
        .ar-launch-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 18px 45px;
            border-radius: 4px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <canvas id="matrix-canvas"></canvas>

    <nav><div class="logo">XR_TRAINING_LABS_v2.0</div></nav>

    <section>
        <h1>XR Training Labs</h1>
        <h2 class="sub-heading">Spatial Computing Training Systems</h2>
        <p class="intro-text">
            Spatial Computing Training Systems leverage augmented reality and computer vision to bridge the gap between theoretical knowledge and practical application. We have experience in designing, developing and deployment of training in 3d, mixed and virtual reality, using Moodle, Web, Apps and VR headsets.
        </p>

        <div class="ar-content">DIAGNOSTIC_RECORDS // VIDEO_LIBRARY</div>
        <p class="intro-text">
            Here are some videos that show currently deployed training built by our team.        
        </p>
        <div class="grid-container">
            <div class="video-card" data-video="_ckPvnl4HQI">
                <iframe src="https://www.youtube.com/embed/_ckPvnl4HQI?controls=0&mute=1&enablejsapi=1"></iframe>
            </div>
            <div class="video-card" data-video="2OvfLt13D6Y">
                <iframe src="https://www.youtube.com/embed/2OvfLt13D6Y?controls=0&mute=1&enablejsapi=1"></iframe>
            </div>
            <div class="video-card" data-video="8kNXOVutOJc">
                <iframe src="https://www.youtube.com/embed/8kNXOVutOJc?controls=0&mute=1&enablejsapi=1"></iframe>
            </div>
            <div class="video-card" data-video="0m-LbA8E97Q">
                <iframe src="https://www.youtube.com/embed/0m-LbA8E97Q?controls=0&mute=1&enablejsapi=1"></iframe>
            </div>
        </div>
    </section>

    <section style="min-height: 100vh;">
        <div class="ar-content">SPATIAL_SYNC: CHINOOK_CH47D</div>
        <div id="hand-ui">
            <button class="cam-btn" id="t-btn">INITIALIZE SENSORS</button>
            <div id="preview-wrapper">
                <video id="v-preview" autoplay playsinline></video>
            </div>
        </div>

        <div class="model-card">
            <div id="tech-hud">
                <div>[SYSTEM STATUS: X-RAY ACTIVE]</div>
                <div>---------------------------</div>
                <div>STRUCTURAL INTEGRITY: 98.4%</div>
            </div>

            <model-viewer id="xr-model" 
                src="models/chinook-2.glb" 
                ios-src="models/Chinook-2.usdz"
                ar ar-modes="quick-look webxr scene-viewer" 
                ar-placement="floor"
                camera-controls 
                shadow-intensity="1" 
                camera-orbit="0deg 75deg 12m"
                touch-action="none">
            </model-viewer>
        </div>

        <div class="ar-controls">
            <button class="ar-launch-btn" onclick="document.querySelector('#xr-model').activateAR()">
                Launch Spatial AR
            </button>
        </div>
    </section>

    <script>
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');

        // Adjust dimensions
        function setCanvasSize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        setCanvasSize();
        window.addEventListener('resize', setCanvasSize);

        const fontSize = 16;
        const columns = Math.floor(canvas.width / fontSize);
        const drops = Array(columns).fill(0);

        function drawMatrix() {
            // Background fill with slight opacity to create fading trails
            ctx.fillStyle = 'rgba(3, 5, 8, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Set character color - Binary (1 and 0)
            ctx.fillStyle = 'rgba(0, 255, 70, 0.35)'; // Increased opacity
            ctx.font = fontSize + 'px "Source Code Pro", monospace';

            for (let i = 0; i < drops.length; i++) {
                const text = Math.floor(Math.random() * 2); // Random 0 or 1
                const x = i * fontSize;
                const y = drops[i] * fontSize;

                ctx.fillText(text, x, y);

                // Reset drop to top randomly
                if (y > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        // Run animation loop
        setInterval(drawMatrix, 50);
    </script>

    <script>
        // ... (Handtracking and Grid logic from previous version remains identical) ...
        const cards = document.querySelectorAll('.video-card');
        cards.forEach((card) => {
            const iframe = card.querySelector('iframe');
            const videoId = card.getAttribute('data-video');
            const originalSrc = iframe.src;
            card.addEventListener('mouseenter', () => {
                gsap.to(card, { scale: 1.15, zIndex: 100, boxShadow: "0 25px 50px rgba(99, 102, 241, 0.3)", duration: 0.4 });
                iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&enablejsapi=1`;
                cards.forEach(other => { if (other !== card) gsap.to(other, { opacity: 0.3, scale: 0.95, duration: 0.4 }); });
            });
            card.addEventListener('mouseleave', () => {
                gsap.to(card, { scale: 1.0, zIndex: 1, boxShadow: "0 0 0 rgba(0,0,0,0)", duration: 0.3 });
                iframe.src = originalSrc;
                cards.forEach(other => { gsap.to(other, { opacity: 1, scale: 1.0, duration: 0.3 }); });
            });
        });

        const video = document.getElementById("v-preview");
        const modelViewer = document.querySelector("#xr-model");
        const trackBtn = document.getElementById("t-btn");
        const previewWrapper = document.getElementById("preview-wrapper");
        const hud = document.getElementById("tech-hud");
        let isTracking = false;
        let xRayEnabled = false;

        handTrack.load({ flipHorizontal: true, maxNumBoxes: 1, scoreThreshold: 0.5 }).then(m => {
            detectionModel = m;
            trackBtn.innerText = "SENSORS READY";
        });

        trackBtn.addEventListener("click", () => {
            if (!isTracking) {
                handTrack.startVideo(video).then(status => {
                    if (status) {
                        isTracking = true;
                        previewWrapper.style.display = "block";
                        trackBtn.innerText = "SENSOR ONLINE";
                        detect();
                    }
                });
            } else {
                handTrack.stopVideo(video);
                isTracking = false;
                previewWrapper.style.display = "none";
                trackBtn.innerText = "SENSORS READY";
            }
        });

        function applyXRay(enable) {
            if (enable === xRayEnabled || !modelViewer.model) return;
            xRayEnabled = enable;
            hud.classList.toggle('active', enable);
            const materials = modelViewer.model.materials;
            materials.forEach(mat => {
                if (enable) {
                    mat.setAlphaMode("BLEND");
                    mat.pbrMetallicRoughness.setBaseColorFactor([0.2, 0.4, 1.0, 0.25]);
                } else {
                    mat.setAlphaMode("OPAQUE");
                    mat.pbrMetallicRoughness.setBaseColorFactor([1, 1, 1, 1]);
                }
            });
        }

        function detect() {
            detectionModel.detect(video).then(predictions => {
                const hand = predictions.find(p => p.label !== 'face');
                if (hand) {
                    const [x, y, w, h] = hand.bbox;
                    const rY = ((x + w/2) / 160) * 360 - 180;
                    modelViewer.cameraOrbit = `${rY}deg 75deg 12m`;
                    if (["closed", "fist"].includes(hand.label)) applyXRay(true); else applyXRay(false);
                }
                if (isTracking) requestAnimationFrame(detect);
            });
        }
    </script>
</body>
</html>
